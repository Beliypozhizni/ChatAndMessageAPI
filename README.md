# Chat & Message API

Учебный REST API для работы с чатами и сообщениями.

Проект реализован на **FastAPI** с использованием **PostgreSQL**, **SQLAlchemy (async)** и **Alembic**.  
Поддерживает создание чатов, отправку сообщений, получение последних сообщений и каскадное удаление данных.

---

## Функциональность

### Chats
- Создание чата
- Получение чата с последними N сообщениями
- Удаление чата (со всеми сообщениями)

### Messages
- Отправка сообщений в чат
- Ограничение длины сообщения (1–5000 символов)
- Каскадное удаление сообщений при удалении чата

---

## Технологии

- Python 3.13
- FastAPI
- SQLAlchemy 2.x (async)
- PostgreSQL
- Alembic (миграции)
- Pydantic v2
- Poetry (PEP 621)
- Docker / Docker Compose

---

## Архитектура

- `src/` — основной код приложения (src-layout)
- `alembic/` — миграции БД
- `tests/` — интеграционные тесты (реальная БД)
- `docker-compose.yml` — запуск API + PostgreSQL
- `Dockerfile` — production-ready образ
- `.env*` — конфигурация окружений

---

## API (кратко)

### Chats
- `POST /api/v1/chats/` — создать чат
- `GET /api/v1/chats/{id}?limit=N` — получить чат и последние N сообщений (по умолчанию 20, максимум 100)
- `DELETE /api/v1/chats/{id}` — удалить чат и все сообщения

### Messages
- `POST /api/v1/chats/{id}/messages/` — отправить сообщение в чат

---

## Запуск проекта (Docker)

### Требования
- Docker
- Docker Compose

### Запуск

```
docker compose up --build
```

---

## Локальный запуск (без Docker)

Для локальной разработки и тестирования используются файлы окружения `.env` и `.env.test`.

Перед первым запуском необходимо создать их из примера и настроить:

```
cp .env.example .env
cp .env.example .env.test
```
.env — конфигурация для обычного запуска приложения

.env.test — конфигурация для запуска тестов

Для переключения между конфигурациями используется переменная окружения ENV_FILE

```
$env:ENV_FILE = ".env"
```
or
```
$env:ENV_FILE = ".env.test"
pytest
```
Для управления зависимостями в проекте используется Poetry.
Установка зависимостей:
```
poetry install
```

Запуск:
```
python -m src.main
```
---